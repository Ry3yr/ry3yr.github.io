<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dress-Up GIF Export</title>
<style>
body {margin:0; font-family:system-ui,sans-serif; background:#fff; color:#fff; display:flex; height:100vh;}
#toolbar {width:300px; background:#1c1c1c; border-right:1px solid #333; display:flex; flex-direction:column;}
#controls {padding:10px;}
button {width:100%; margin-bottom:6px; padding:8px; background:#333; color:#fff; border:none; cursor:pointer;}
button:hover {background:#444;}
button:disabled {background:#222; opacity:0.5; cursor:default;}
#browser {flex:1; overflow-y:auto; border-top:1px solid #333; padding:6px;}
.thumb {background:#222; margin-bottom:6px; padding:6px; cursor:pointer; font-size:11px;}
.thumb img {max-width:100%; max-height:80px; display:block; margin:auto;}
#canvasWrap {flex:1; display:flex; justify-content:center; align-items:center;}
#avatarWrap {position:relative; width:500px; height:600px; border:1px solid #dff; background:#fff; overflow:hidden;}
.layer-wrap {position:absolute; cursor:grab; user-select:none; transform-origin:top left;}
.layer-wrap .controls {position:absolute; top:-18px; right:0; display:flex; gap:4px;}
.layer-wrap .ctrl {background:#000; border:1px solid #fff; color:#fff; font-size:12px; padding:0 6px; cursor:pointer;}
.layer-wrap .remove {position:absolute; bottom:0; left:0; background:#900; border:1px solid #fff; color:#fff; font-size:12px; padding:0 4px; cursor:pointer;}
.locked {outline:2px solid #2ecc71;}
#cropRect {position:absolute; border:2px dashed #0f0; cursor:move; display:none; background:rgba(0,0,0,0.1);}
#cropControls {position:absolute; top:-18px; right:0; display:flex; gap:2px;}
#cropControls button {background:#0a0; border:none; color:#fff; cursor:pointer; font-size:12px; padding:1px 4px;}
#previewCanvas {border:2px solid #0f0; margin:10px auto; display:block;}
#recordStatus {font-size:12px; color:#0f0; margin-top:10px;}
#zipOption {margin-top:8px; font-size:13px;}
.hide-ui .layer-wrap .controls,
.hide-ui .layer-wrap .remove,
.hide-ui #cropRect,
.hide-ui #cropControls,
.hide-ui .locked {display:none !important;}
.hide-ui .layer-wrap {cursor:default;}
</style>
</head>
<body>
<div id="toolbar">
  <div id="controls">
    <button id="clearViewBtn">üëÅ Toggle Clear View</button>
    <button id="lockBtn">üîí Lock Main Image</button>
    <button id="exportBtn">‚ú® Looking good (URL)</button>
    <button id="gifBtn">üé¨ GIF Please (Crop)</button>
    <button id="previewBtn">üëÅ Preview Crop</button>
    <button id="downloadGifBtn">üíæ Record & Download</button>
    <div id="zipOption">
      <label><input type="checkbox" id="zipCheckbox"> Zip download (individual PNG frames instead of GIF)</label>
    </div>
    <div id="recordStatus"></div>
    <p style="font-size:11px;opacity:.6">Drag layers ‚Ä¢ +/‚àí to scale ‚Ä¢ crop with green box<br>Add animated clothing/accessories for animation</p>
  </div>
  <div id="browser"></div>
  <canvas id="previewCanvas"></canvas>
</div>
<div id="canvasWrap">
  <div id="avatarWrap">
    <div id="cropRect" data-html2canvas-ignore>
      <div id="cropControls">
        <button id="cropPlus">+</button>
        <button id="cropMinus">‚àí</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
const avatarWrap = document.getElementById("avatarWrap");
const browser = document.getElementById("browser");
const cropRect = document.getElementById("cropRect");
const previewCanvas = document.getElementById("previewCanvas");
const previewCtx = previewCanvas.getContext("2d");
const recordStatus = document.getElementById("recordStatus");
const downloadGifBtn = document.getElementById("downloadGifBtn");
const zipCheckbox = document.getElementById("zipCheckbox");
const params = new URLSearchParams(location.search);
const DEFAULT_WEBDIR = "https://alcea-wisteria.de/z_files/akkomadressup/";
const webdir = params.get("webdir") || DEFAULT_WEBDIR;
let layers = [], active = null, offsetX = 0, offsetY = 0;
let mainLocked = false, zCounter = 10;
let cropActive = false;
let clearViewMode = false;
cropRect.setAttribute('data-html2canvas-ignore', '');
/* ---------- CLEAR VIEW TOGGLE ---------- */
document.getElementById("clearViewBtn").onclick = () => {
  clearViewMode = !clearViewMode;
  if (clearViewMode) {
    avatarWrap.classList.add("hide-ui");
    document.getElementById("clearViewBtn").textContent = "üëÅ Restore UI";
  } else {
    avatarWrap.classList.remove("hide-ui");
    document.getElementById("clearViewBtn").textContent = "üëÅ Toggle Clear View";
  }
};
/* ---------- CREATE LAYER ---------- */
function createLayer(src, isMain = false, behind = false, scale = 1, x = null, y = null) {
  const wrap = document.createElement("div");
  wrap.className = "layer-wrap";
  wrap.dataset.main = isMain ? "1" : "0";
  wrap.dataset.behind = behind ? "1" : "0";
  wrap.dataset.scale = scale;
  const img = document.createElement("img");
  img.crossOrigin = "anonymous";
  img.src = src;
  img.style.transform = `scale(${scale})`;
  wrap.style.left = (x !== null ? x : 50) + "px";
  wrap.style.top = (y !== null ? y : 50) + "px";
  wrap.style.zIndex = isMain ? 5 : (behind ? 1 : ++zCounter);
  wrap.appendChild(img);
  if (!isMain) {
    const ctrls = document.createElement("div"); ctrls.className = "controls";
    const plus = document.createElement("div"); plus.className = "ctrl"; plus.textContent = "+";
    plus.onclick = e => { e.stopPropagation(); scaleLayer(wrap, 1.1); };
    const minus = document.createElement("div"); minus.className = "ctrl"; minus.textContent = "‚àí";
    minus.onclick = e => { e.stopPropagation(); scaleLayer(wrap, 0.9); };
    ctrls.append(minus, plus); wrap.appendChild(ctrls);
    ctrls.setAttribute('data-html2canvas-ignore', '');
    const remove = document.createElement("div"); remove.className = "remove"; remove.textContent = "√ó";
    remove.onclick = e => { e.stopPropagation(); avatarWrap.removeChild(wrap); layers = layers.filter(l => l !== wrap); };
    wrap.appendChild(remove);
    remove.setAttribute('data-html2canvas-ignore', '');
  }
  wrap.addEventListener("mousedown", e => {
    if (isMain && mainLocked) return;
    if (clearViewMode) return; // Disable dragging in clear view mode
    active = wrap;
    const rect = wrap.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    wrap.style.zIndex = ++zCounter;
  });
  avatarWrap.appendChild(wrap);
  layers.push(wrap);
  
  // Apply clear view mode to new layer if active
  if (clearViewMode) {
    avatarWrap.classList.add("hide-ui");
  }
}
function scaleLayer(wrap, factor) {
  if (clearViewMode) return; // Disable scaling in clear view mode
  let s = parseFloat(wrap.dataset.scale) * factor;
  s = Math.max(0.1, Math.min(5, s));
  wrap.dataset.scale = s;
  wrap.querySelector("img").style.transform = `scale(${s})`;
}
/* ---------- DRAG LAYERS ---------- */
document.addEventListener("mousemove", e => {
  if (!active || clearViewMode) return; // Disable dragging in clear view mode
  let newX = e.clientX - avatarWrap.getBoundingClientRect().left - offsetX;
  let newY = e.clientY - avatarWrap.getBoundingClientRect().top - offsetY;
  newX = Math.max(0, Math.min(newX, avatarWrap.clientWidth - active.offsetWidth));
  newY = Math.max(0, Math.min(newY, avatarWrap.clientHeight - active.offsetHeight));
  active.style.left = newX + "px";
  active.style.top = newY + "px";
});
document.addEventListener("mouseup", () => active = null);
/* ---------- LOCK MAIN ---------- */
document.getElementById("lockBtn").onclick = () => {
  if (clearViewMode) return; // Disable locking in clear view mode
  mainLocked = !mainLocked;
  const main = layers.find(l => l.dataset.main === "1");
  if (main) main.classList.toggle("locked", mainLocked);
};
/* ---------- EXPORT URL ---------- */
document.getElementById("exportBtn").onclick = () => {
  if (clearViewMode) return; // Disable export in clear view mode
  const out = new URL(location.origin + location.pathname);
  let i = 1; out.searchParams.set("webdir", webdir);
  layers.forEach(l => {
    const x = parseInt(l.style.left), y = parseInt(l.style.top);
    if (l.dataset.main === "1") {
      out.searchParams.set("img", l.querySelector("img").src);
      out.searchParams.set("imgx", x); out.searchParams.set("imgy", y);
    } else {
      out.searchParams.set("dressup" + i, l.querySelector("img").src);
      out.searchParams.set("dx" + i, x); out.searchParams.set("dy" + i, y);
      out.searchParams.set("scale" + i, l.dataset.scale);
      out.searchParams.set("behind" + i, l.dataset.behind);
      i++;
    }
  });
  navigator.clipboard.writeText(out.toString());
  alert("Scene URL copied to clipboard!");
};
/* ---------- RESTORE FROM URL ---------- */
params.forEach((v, k) => {
  if (k === "img") createLayer(v, true, false, 1, parseInt(params.get("imgx")) || 0, parseInt(params.get("imgy")) || 0);
  if (k.startsWith("dressup")) {
    const i = k.replace("dressup", "");
    createLayer(v, false, params.get("behind" + i) === "1", parseFloat(params.get("scale" + i)) || 1,
                parseInt(params.get("dx" + i)) || 50, parseInt(params.get("dy" + i)) || 50);
  }
});
/* ---------- IMAGE BROWSER ---------- */
fetch(webdir).then(r => r.text()).then(html => {
  const doc = new DOMParser().parseFromString(html, "text/html");
  const seen = new Set();
  doc.querySelectorAll("a[href]").forEach(a => {
    const href = a.getAttribute("href");
    if (!href || !href.match(/\.(png|jpg|jpeg|gif|apng)$/i)) return;
    const full = new URL(href, webdir).href;
    if (seen.has(full)) return; seen.add(full);
    const div = document.createElement("div"); div.className = "thumb";
    div.innerHTML = `<img src="${full}"><div>${full.split("/").pop()}</div>`;
    div.onclick = () => createLayer(full);
    browser.appendChild(div);
  });
});
/* ---------- CROP CONTROLS ---------- */
document.getElementById("gifBtn").onclick = () => {
  if (clearViewMode) return; // Disable crop in clear view mode
  cropRect.style.display = "block";
  cropRect.style.left = "50px";
  cropRect.style.top = "50px";
  cropRect.style.width = "380px";
  cropRect.style.height = "500px";
};
// Drag / resize crop
cropRect.addEventListener("mousedown", e => {
  if (e.target.tagName === "BUTTON" || clearViewMode) return; // Disable in clear view
  cropActive = true;
  const rect = cropRect.getBoundingClientRect();
  offsetX = e.clientX - rect.left;
  offsetY = e.clientY - rect.top;
});
document.addEventListener("mousemove", e => {
  if (!cropActive || clearViewMode) return; // Disable in clear view
  let newX = e.clientX - avatarWrap.getBoundingClientRect().left - offsetX;
  let newY = e.clientY - avatarWrap.getBoundingClientRect().top - offsetY;
  newX = Math.max(0, Math.min(newX, 400 - parseInt(cropRect.style.width)));
  newY = Math.max(0, Math.min(newY, 600 - parseInt(cropRect.style.height)));
  cropRect.style.left = newX + "px";
  cropRect.style.top = newY + "px";
});
document.addEventListener("mouseup", () => cropActive = false);
document.getElementById("cropPlus").onclick = () => {
  if (clearViewMode) return; // Disable in clear view
  let w = parseInt(cropRect.style.width) + 20;
  let h = parseInt(cropRect.style.height) + 20;
  w = Math.min(w, 500 - parseInt(cropRect.style.left));
  h = Math.min(h, 600 - parseInt(cropRect.style.top));
  cropRect.style.width = w + "px";
  cropRect.style.height = h + "px";
};
document.getElementById("cropMinus").onclick = () => {
  if (clearViewMode) return; // Disable in clear view
  let w = Math.max(50, parseInt(cropRect.style.width) - 20);
  let h = Math.max(50, parseInt(cropRect.style.height) - 20);
  cropRect.style.width = w + "px";
  cropRect.style.height = h + "px";
};
/* ---------- PREVIEW ---------- */
document.getElementById("previewBtn").onclick = async () => {
  if (clearViewMode) return; // Disable preview in clear view mode
  const cx = parseInt(cropRect.style.left);
  const cy = parseInt(cropRect.style.top);
  const cw = parseInt(cropRect.style.width);
  const ch = parseInt(cropRect.style.height);
  const fullCanvas = await html2canvas(avatarWrap, {
    backgroundColor: null,
    useCORS: true,
    allowTaint: false,
    ignoreElements: el => el.hasAttribute('data-html2canvas-ignore')
  });
  previewCanvas.width = cw;
  previewCanvas.height = ch;
  previewCtx.drawImage(fullCanvas, cx, cy, cw, ch, 0, 0, cw, ch);
};
/* ---------- RECORD & DOWNLOAD ---------- */
downloadGifBtn.onclick = async () => {
  if (clearViewMode) return; // Disable download in clear view mode
  if (cropRect.style.display === 'none') {
    alert('Please activate the crop area first with "GIF Please (Crop)"');
    return;
  }
  downloadGifBtn.disabled = true;
  recordStatus.textContent = 'Preparing...';
  const cx = parseInt(cropRect.style.left);
  const cy = parseInt(cropRect.style.top);
  const cw = parseInt(cropRect.style.width);
  const ch = parseInt(cropRect.style.height);
  const animatedLayers = layers.filter(l => {
    const img = l.querySelector('img');
    return img && img.src.toLowerCase().endsWith('.gif');
  });
  let frameDelay = 100; // default 10fps
  if (animatedLayers.length > 0) {
    const allDelays = [];
    for (const layer of animatedLayers) {
      const img = layer.querySelector('img');
      const response = await fetch(img.src, { mode: 'cors' });
      const buffer = await response.arrayBuffer();
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.length - 6; i++) {
        if (bytes[i] === 0x21 && bytes[i+1] === 0xF9) {
          const delay = (bytes[i+4] | (bytes[i+5] << 8)) * 10;
          if (delay > 0) allDelays.push(delay);
        }
      }
    }
    if (allDelays.length > 0) {
      frameDelay = Math.min(...allDelays);
    }
  }
  const maxFrames = 100;
  const useZip = zipCheckbox.checked;
  const capturedFrames = []; // store crop canvases or blobs
  recordStatus.textContent = `Capturing ${maxFrames} frames...`;
  // Restart animations to sync
  const loadPromises = [];
  for (const layer of animatedLayers) {
    const img = layer.querySelector('img');
    const baseSrc = img.src.split('?')[0];
    img.src = '';
    img.src = baseSrc + '?t=' + Date.now();
    loadPromises.push(new Promise(res => img.addEventListener('load', res, {once: true})));
  }
  await Promise.all(loadPromises);
  // Small delay to ensure animation starts
  await new Promise(res => setTimeout(res, 50));
  for (let f = 0; f < maxFrames; f++) {
    const fullCanvas = await html2canvas(avatarWrap, {
      backgroundColor: null,
      useCORS: true,
      allowTaint: false,
      ignoreElements: el => el.hasAttribute('data-html2canvas-ignore')
    });
    const cropCanvas = document.createElement('canvas');
    cropCanvas.width = cw;
    cropCanvas.height = ch;
    const ctx = cropCanvas.getContext('2d');
    ctx.drawImage(fullCanvas, cx, cy, cw, ch, 0, 0, cw, ch);
    if (useZip) {
      const blob = await new Promise(resolve => cropCanvas.toBlob(resolve, 'image/png'));
      capturedFrames.push(blob);
    } else {
      capturedFrames.push(ctx);
    }
    recordStatus.textContent = `Captured ${f+1}/${maxFrames} frames...`;
    await new Promise(res => setTimeout(res, frameDelay));
  }
  if (useZip) {
    recordStatus.textContent = 'Creating ZIP (this may take a moment)...';
    const zip = new JSZip();
    capturedFrames.forEach((blob, i) => {
      zip.file(`frame_${String(i+1).padStart(3, '0')}.png`, blob);
    });
    const zipBlob = await zip.generateAsync({type: "blob"});
    downloadBlob(zipBlob, 'my-animated-frames.zip');
    recordStatus.textContent = 'ZIP downloaded!';
  } else {
    recordStatus.textContent = 'Rendering GIF (this may take a while)...';
    const gif = new GIF({
      workers: 4,
      quality: 10,
      width: cw,
      height: ch
    });
    capturedFrames.forEach(ctx => {
      gif.addFrame(ctx, {copy: true, delay: frameDelay});
    });
    gif.on('finished', blob => {
      downloadBlob(blob, 'my-animated-avatar.gif');
      recordStatus.textContent = 'GIF downloaded!';
    });
    gif.render();
  }
  downloadGifBtn.disabled = false;
};
function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>